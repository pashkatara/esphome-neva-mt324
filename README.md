# esphome-neva-mt324
ESPHome Component for Neva MT 324 Smart Meter
Компонент ESPHome для считывания показаний счетчика электроэнергии Нева МТ 324 (и серии MT 3xx) по интерфейсу RS-485.

Позволяет получить данные о напряжении, токе, мощности и тарифах в Home Assistant без использования инфракрасного порта (оптопары), через надежное проводное подключение.

Neva MT324

Особенности
Чтение данных через RS-485 (протокол IEC 62056-21 / OBIS).
Поддержка трехфазных показаний: Напряжение (V), Ток (A), Мощность (W).
Чтение тарифов: Т1, Т2, Общий счетчик.
Автоматическая авторизация в счетчике.
Интеграция с Home Assistant через ESPHome.
Поддерживаемые счетчики
Тестировалось на: Нева МТ 324 AR 1.0

Возможно работает с другими моделями серии Нева МТ (314, 323), поддерживающими протокол OBIS-Z.
<img width="610" height="566" alt="neva324" src="https://github.com/user-attachments/assets/63081c07-e093-4cd7-9f60-cef4df3b492d" />
![uart_ttl_to_rs485_two-way_converter_06](https://github.com/user-attachments/assets/bc24653a-bb71-49cc-9d7e-c6466fe1d471)
# Необходимое оборудование
ESP32 (или ESP8266, но пример для ESP32).
Модуль RS-485 to TTL (на чипе MAX485 или аналогичном).
Провода для подключения к клеммам счетчика.
Подключение (Wiring)
Клеммы счетчика
Нева МТ 324 имеет клеммы интерфейса EIA485:

A+ (Line A)
B- (Line B)
Схема (ESP32 + MAX485)
ESP32 RS485 Module Счетчик (Meter)
<img width="658" height="867" alt="Screenshot_8" src="https://github.com/user-attachments/assets/77957205-1ffd-4acd-b56d-39694588916f" />


*Примечание:* Если используете готовый модуль с автоматическим направлением (Auto-direction), пин DE/RE подключать не нужно. В коде используется программное управление, но для многих модулей (вроде тех, что на базе MAX3485 с транзистором) достаточно просто замкнуть DE и RE на VCC (режим постоянной передачи, так как счетчик отвечает редко, но это может вызывать коллизии). Рекомендуется управление пином.

## Установка

1. Добавьте файл `neva-mt324.yaml` в вашу папку ESPHome.
2. Укажите свои WiFi кредлы (или используйте `!secret`).
3. Прошейте ESP32.
4. Устройство автоматически появится в Home Assistant.

## Конфигурация

Файл конфигурации включает в себя:
- Настройку UART.
- Скрипт авторизации (Handshake).
- Запрос OBIS-кодов для напряжений, токов, мощности и тарифов.

### Список сенсоров

| Сенсор              | OBIS Code | Описание |
|---------------------|-----------|----------|
| Напряжение L1       | 20.7.0    | V |
| Напряжение L2       | 34.7.0    | V |
| Напряжение L3       | 48.7.0    | V |
| Ток L1              | 31.7.0    | A |
| Ток L2              | 51.7.0    | A |
| Ток L3              | 71.7.0    | A |
| Суммарная мощность  | 16.7.0    | W |
| Энергия Т1          | ...       | kWh |
| Энергия Т2          | ...       | kWh |

## Благодарности

- Проект вдохновлен [latonita/esphome-energomera-iec](https://github.com/latonita/esphome-energomera-iec).
- Спасибо сообществу ESPHome за документацию по UART.

## License
MIT
